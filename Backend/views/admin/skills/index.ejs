<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-chart-bar"></i> Skills Management</h2>
  <a href="/admin/skills/new" class="btn btn-admin-primary">
    <i class="fas fa-plus"></i> Add New Skill
  </a>
</div>

<div class="admin-card">
  <div class="card-header bg-transparent border-0 py-3">
    <div class="row align-items-center">
      <div class="col">
        <h6 class="mb-0">Total Skills: <%= totalCount %></h6>
      </div>
    </div>
  </div>

  <% if (Object.keys(groupedSkills).length > 0) { %>
  <div class="card-body">
    <% Object.keys(groupedSkills).forEach(function(category) { %>
    <div class="mb-4">
      <h5 class="text-capitalize mb-3">
        <i
          class="fas fa-<%= category === 'frontend' ? 'laptop-code' : category === 'backend' ? 'server' : category === 'database' ? 'database' : 'tools' %>"
        ></i>
        <%= category.replace('-', ' ') %> (<%= groupedSkills[category].length
        %>)
      </h5>

      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Skill</th>
              <th>Proficiency</th>
              <th>Experience</th>
              <th>Visible</th>
              <th>Order</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% groupedSkills[category].forEach(function(skill) { %>
            <tr data-skill-id="<%= skill.id %>">
              <td>
                <div class="d-flex align-items-center">
                  <% if (skill.icon) { %>
                  <i
                    class="<%= skill.icon %> me-2"
                    data-color="<%= skill.color %>"
                  ></i>
                  <% } %>
                  <div>
                    <h6 class="mb-0"><%= skill.name %></h6>
                    <% if (skill.description) { %>
                    <small class="text-muted"
                      ><%= skill.description.substring(0, 40) %>...</small
                    >
                    <% } %>
                  </div>
                </div>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="progress me-2" style="width: 80px; height: 6px">
                    <div
                      class="progress-bar"
                      data-width="<%= skill.proficiency %>"
                      data-color="<%= skill.color %>"
                    ></div>
                  </div>
                  <small class="proficiency-value"
                    ><%= skill.proficiency %>%</small
                  >
                </div>
                <!-- Instant proficiency update -->
                <div class="mt-1">
                  <input
                    type="range"
                    class="form-range proficiency-slider"
                    min="1"
                    max="100"
                    value="<%= skill.proficiency %>"
                    data-skill-id="<%= skill.id %>"
                    style="width: 80px"
                  />
                </div>
              </td>
              <td>
                <small
                  ><%= skill.yearsOfExperience %> year<%=
                  skill.yearsOfExperience !== 1 ? 's' : '' %></small
                >
              </td>
              <td>
                <button
                  class="btn btn-sm toggle-visibility"
                  data-skill-id="<%= skill.id %>"
                  data-visible="<%= skill.isVisible %>"
                >
                  <% if (skill.isVisible) { %>
                  <i class="fas fa-eye text-success"></i>
                  <% } else { %>
                  <i class="fas fa-eye-slash text-muted"></i>
                  <% } %>
                </button>
              </td>
              <td>
                <span class="badge bg-light text-dark"><%= skill.order %></span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a
                    href="/admin/skills/<%= skill.id %>/edit"
                    class="btn btn-outline-primary"
                    title="Edit"
                  >
                    <i class="fas fa-edit"></i>
                  </a>
                  <form
                    action="/admin/skills/<%= skill.id %>"
                    method="POST"
                    class="d-inline delete-form"
                    data-skill-name="<%= skill.name %>"
                  >
                    <input type="hidden" name="_method" value="DELETE" />
                    <button
                      type="submit"
                      class="btn btn-outline-danger"
                      title="Delete"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
    <% }); %>
  </div>
  <% } else { %>
  <div class="card-body text-center py-5">
    <div class="mb-3">
      <i class="fas fa-chart-bar fa-3x text-muted"></i>
    </div>
    <h5>No Skills Found</h5>
    <p class="text-muted">Start by adding your first skill.</p>
    <a href="/admin/skills/new" class="btn btn-admin-primary">
      <i class="fas fa-plus"></i> Add First Skill
    </a>
  </div>
  <% } %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Apply styles dynamically to avoid EJS/CSS conflicts
    const icons = document.querySelectorAll("i[data-color]");
    icons.forEach((icon) => {
      icon.style.color = icon.dataset.color;
    });

    const progressBars = document.querySelectorAll(".progress-bar");
    progressBars.forEach((bar) => {
      bar.style.width = bar.dataset.width + "%";
      bar.style.backgroundColor = bar.dataset.color;
    });

    // Handle proficiency slider changes
    const sliders = document.querySelectorAll(".proficiency-slider");
    sliders.forEach((slider) => {
      slider.addEventListener("input", function () {
        const skillId = this.dataset.skillId;
        const newValue = this.value;
        const row = this.closest("tr");
        const proficiencyValue = row.querySelector(".proficiency-value");
        const progressBar = row.querySelector(".progress-bar");

        // Update UI instantly
        proficiencyValue.textContent = newValue + "%";
        progressBar.style.width = newValue + "%";

        // Send update to server
        fetch(`/admin/skills/${skillId}/update-proficiency`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ proficiency: parseInt(newValue) }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Show success feedback
              const originalColor = progressBar.style.backgroundColor;
              progressBar.style.backgroundColor = "#28a745";
              setTimeout(() => {
                progressBar.style.backgroundColor = originalColor;
              }, 500);
            } else {
              alert("Error updating proficiency: " + data.message);
              // Revert UI on error
              this.value = proficiencyValue.textContent.replace("%", "");
              progressBar.style.width = this.value + "%";
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error updating proficiency");
            // Revert UI on error
            this.value = proficiencyValue.textContent.replace("%", "");
            progressBar.style.width = this.value + "%";
          });
      });
    });

    // Handle visibility toggle
    const toggleButtons = document.querySelectorAll(".toggle-visibility");
    toggleButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const skillId = this.dataset.skillId;
        const isVisible = this.dataset.visible === "true";
        const icon = this.querySelector("i");

        // Send update to server
        fetch(`/admin/skills/${skillId}/toggle-visibility`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Update UI instantly
              this.dataset.visible = !isVisible;
              if (!isVisible) {
                icon.className = "fas fa-eye text-success";
              } else {
                icon.className = "fas fa-eye-slash text-muted";
              }
            } else {
              alert("Error toggling visibility: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error toggling visibility");
          });
      });
    });

    // Handle delete confirmation
    const deleteForms = document.querySelectorAll(".delete-form");
    deleteForms.forEach((form) => {
      form.addEventListener("submit", function (e) {
        const skillName = this.dataset.skillName;
        if (
          !confirm(`Are you sure you want to delete the skill "${skillName}"?`)
        ) {
          e.preventDefault();
        }
      });
    });
  });
</script>
